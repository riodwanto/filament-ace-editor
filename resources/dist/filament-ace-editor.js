function G({state:E,statePath:T,placeholder:w,aceUrl:L,extensions:p,config:F={},options:m={},darkTheme:v,disableDarkTheme:y,completions:R=[],snippets:M=[],enableCustomCompletions:U=!1,toolbarButtons:P=[],hasToolbar:$=!1,showStatusBar:O=!1,statusBarOptions:k={},extensionLoadingConfig:I={},keyboardAccessibility:B=!1,screenReaderSupport:z=!1,ariaLabels:A={},currentFontSize:W="14px",currentWordWrap:H="off",overscrollOptions:V={},isDisabled:D=!1}){return{state:E,statePath:T,placeholder:w,options:m,darkTheme:v,disableDarkTheme:y,completions:R,snippets:M,enableCustomCompletions:U,toolbarButtons:P,hasToolbar:$,showStatusBar:O,statusBarOptions:k,isDisabled:D,editor:null,observer:null,shouldUpdateState:!0,isDestroyed:!1,isFullscreen:!1,loadedScripts:[],eventListeners:[],intersectionObserver:null,isVisible:!1,isInitialized:!1,virtualScrolling:{enabled:!1,maxLines:1e3,bufferSize:50,threshold:1e4,originalMaxLines:null,originalMinLines:null,scrollHandler:null,resizeHandler:null,lastScrollTop:0,viewportHeight:0,lineHeight:0},progressiveEnhancement:{currentStage:0,stages:{0:{name:"core",features:["basicEditing","syntaxHighlighting","basicTheme"],loaded:!1,priority:1},1:{name:"intermediate",features:["autocompletion","findReplace","toolbar"],loaded:!1,priority:2,delay:100},2:{name:"advanced",features:["languageTools","customCompletions","statusBar","virtualScrolling","advancedExtensions"],loaded:!1,priority:3,delay:300}},loadingPromises:new Map,performanceMetrics:{stageLoadTimes:{},totalLoadTime:0,startTime:0}},toolbarState:{canUndo:!1,canRedo:!1,showPrintMargin:!0,showInvisibles:!1,wordWrapEnabled:!1},statusBarElement:null,statusBarState:{position:{row:1,column:1},selection:{start:{row:1,column:1},end:{row:1,column:1}},lines:1,characters:0,mode:"text",theme:"textmate"},debounceTimers:{statusBarUpdate:null,toolbarUpdate:null},lastToolbarState:{canUndo:!1,canRedo:!1,showPrintMargin:!0,showInvisibles:!1,wordWrapEnabled:!1},lastExpensiveState:{showInvisibles:!1,lastCheckTime:0},printMarginState:{showPrintMargin:!0,printMarginColumn:80,lastUpdateTime:0,updateScheduled:!1,throttledUpdate:null},gotoLineState:{history:[],maxHistory:20,lastGotoLine:1,animationFrame:null,isAnimating:!1},undoRedoState:{canUndo:!1,canRedo:!1,lastCheckTime:0,checkCacheTimeout:50,undoDepth:null,redoDepth:null,lastOperationTime:0,operationQueue:[],isProcessingQueue:!1},caseConversionState:{lastConversionTime:0,conversionCache:new Map,maxCacheSize:100,largeTextThreshold:5e3,operationInProgress:!1},lastFoldState:{canFold:!1,canUnfold:!1,isInsideFold:!1,cursorRow:-1,cursorColumn:-1},statusBarElements:{line:null,column:null,selection:null,mode:null,length:null},domCache:{statusBarContainer:null,lastCacheTime:0,cacheTimeout:1e3},dialogPool:{gotoLine:null,lastUsed:0,reuseTimeout:5e3},extensionCache:{preloaded:new Set,cached:new Map,cacheVersion:"1.0",preloadingPromises:new Map},operationState:{currentOperation:null,operationQueue:[],batchTimeout:null,batchDelay:16,isBatching:!1,renderChanges:0,lastRenderTime:0,pendingChanges:{cursor:!1,selection:!1,text:!1,scroll:!1,gutter:!1}},extensionLoadingConfig:I,keyboardAccessibility:B,screenReaderSupport:z,ariaLabels:A,currentFontSize:W,currentWordWrap:H,overscrollOptions:V,async init(){if(this.$root.closest(".fi-modal")&&await new Promise(e=>setTimeout(e,300)),this.editor){try{this.editor.destroy()}catch(e){console.warn("Error cleaning up existing editor instance:",e)}this.editor=null}this.setupIntersectionObserver(),(!this.intersectionObserver||this.isVisible)&&(await this.initializeEditor(),this.isInitialized=!0),this.addGlobalFullscreenEscapeHandler()},destroy(){if(!this.isDestroyed){this.isDestroyed=!0;try{this.editor&&(this.editor.session&&this.editor.session.removeAllListeners(),this.editor.selection&&this.editor.selection.removeAllListeners(),this.editor.destroy(),this.editor=null),this.observer&&(this.observer.disconnect(),this.observer=null),this.intersectionObserver&&(this.intersectionObserver.disconnect(),this.intersectionObserver=null),this.virtualScrolling.enabled&&this.disableVirtualScrolling(),this.progressiveEnhancement.loadingPromises.size>0&&(this.progressiveEnhancement.loadingPromises.forEach(e=>{e.cancel&&e.cancel()}),this.progressiveEnhancement.loadingPromises.clear()),this.destroyStatusBar(),this.isFullscreen&&this.toggleFullscreen(),this.eventListeners.forEach(({element:e,type:t,handler:i,options:s})=>{try{e&&i&&e.removeEventListener(t,i,s)}catch(r){console.warn("Failed to remove event listener:",r)}}),this._globalEscapeHandler=null,this.cleanupLoadedScripts(),Object.values(this.debounceTimers).forEach(e=>{e&&clearTimeout(e)}),this.eventListeners=[],this.loadedScripts=[],this.statusBarElements={},this.printMarginState.throttledUpdate&&(cancelAnimationFrame(this.printMarginState.throttledUpdate),this.printMarginState.throttledUpdate=null),this.gotoLineState.animationFrame&&(cancelAnimationFrame(this.gotoLineState.animationFrame),this.gotoLineState.animationFrame=null),this.undoRedoState.operationQueue=[],this.undoRedoState.isProcessingQueue=!1,this.caseConversionState.conversionCache.clear(),this.caseConversionState.operationInProgress=!1,this.operationState.batchTimeout&&(clearTimeout(this.operationState.batchTimeout),this.operationState.batchTimeout=null),this.operationState.operationQueue=[],this.operationState.isBatching=!1,this.extensionCache.preloaded.clear(),this.extensionCache.cached.clear(),this.extensionCache.preloadingPromises.clear()}catch(e){console.error("Error during ACE editor cleanup:",e)}}},cleanupLoadedScripts(){this.loadedScripts.forEach(e=>{document.querySelectorAll(`script[src="${e}"]`).forEach(i=>{i.parentNode&&i.parentNode.removeChild(i)})}),this.loadedScripts=[]},setupIntersectionObserver(){if(!("IntersectionObserver"in window)){console.warn("Intersection Observer not supported, initializing immediately"),this.isVisible=!0;return}if(this.isInitialized){this.isVisible=!0;return}let e=this.$refs.aceCodeEditor;if(!e){console.warn("Editor element not found for Intersection Observer");return}let t={root:null,rootMargin:"50px",threshold:.1};this.intersectionObserver=new IntersectionObserver(i=>{i.forEach(async s=>{s.isIntersecting&&!this.isInitialized&&(this.isVisible=!0,this.intersectionObserver.disconnect(),this.intersectionObserver=null,await this.initializeEditor(),this.isInitialized=!0,this.showEditorElement())})},t),this.intersectionObserver.observe(e)},showEditorElement(){let e=this.$refs.aceCodeEditor,t=this.$root.querySelector(".ace-editor-placeholder");t&&(t.style.display="none"),e&&(e.style.opacity="1",e.style.visibility="visible")},setupVirtualScrolling(){!this.editor||!this.editor.session||this.editor.session.getLength()<=this.virtualScrolling.threshold||(this.virtualScrolling.enabled=!0,this.virtualScrolling.originalMaxLines=this.editor.getOption("maxLines"),this.virtualScrolling.originalMinLines=this.editor.getOption("minLines"),this.editor.setOptions({maxLines:this.virtualScrolling.maxLines,minLines:Math.min(this.virtualScrolling.maxLines,20),animatedScroll:!1,showPrintMargin:!1,highlightGutterLine:!1,displayIndentGuides:!1}),this.setupVirtualScrollHandlers(),this.setupVirtualScrollingMonitoring())},setupVirtualScrollHandlers(){if(!this.editor)return;let e=this.editor.renderer.scroller;this.virtualScrolling.lineHeight=this.editor.renderer.lineHeight,this.virtualScrolling.viewportHeight=e.clientHeight,this.virtualScrolling.scrollHandler=this.throttle(()=>{let t=e.scrollTop,i=Math.floor(t/this.virtualScrolling.lineHeight);this.updateVirtualScrollingRange(i)},16),this.virtualScrolling.resizeHandler=this.debounce(()=>{this.virtualScrolling.viewportHeight=e.clientHeight,this.virtualScrolling.lineHeight=this.editor.renderer.lineHeight},100),this.addEventListener(e,"scroll",this.virtualScrolling.scrollHandler,{passive:!0}),this.addEventListener(window,"resize",this.virtualScrolling.resizeHandler)},updateVirtualScrollingRange(e){if(!this.virtualScrolling.enabled||!this.editor)return;let t=this.editor.renderer.getFirstVisibleRow();Math.abs(e-t)>5&&this.batchVirtualScrollingUpdate(e)},batchVirtualScrollingUpdate(e){this.editor&&requestAnimationFrame(()=>{try{let t=this.editor.session,i=t.getLength();Math.max(0,Math.min(e,i-1)),this.virtualScrolling.lastScrollTop>0&&t.setUndoManager(t.getUndoManager())}catch(t){console.warn("Virtual scrolling update error:",t)}})},setupVirtualScrollingMonitoring(){this.editor&&setInterval(()=>{if(this.virtualScrolling.enabled&&this.editor){let t=this.editor.session.getLength(),i=performance.now();i-this.virtualScrolling.lastUpdateTime>33&&console.warn(`Virtual scrolling performance warning: ${(i-this.virtualScrolling.lastUpdateTime).toFixed(2)}ms for ${t} lines`),this.virtualScrolling.lastUpdateTime=i}},1e3)},disableVirtualScrolling(){this.virtualScrolling.enabled&&(this.virtualScrolling.originalMaxLines!==null&&this.editor.setOption("maxLines",this.virtualScrolling.originalMaxLines),this.virtualScrolling.originalMinLines!==null&&this.editor.setOption("minLines",this.virtualScrolling.originalMinLines),this.virtualScrolling.scrollHandler&&this.removeEventListener(window,"scroll",this.virtualScrolling.scrollHandler),this.virtualScrolling.resizeHandler&&this.removeEventListener(window,"resize",this.virtualScrolling.resizeHandler),this.virtualScrolling.enabled=!1)},initProgressiveEnhancement(){this.editor&&(this.progressiveEnhancement.performanceMetrics.startTime=performance.now(),this.loadProgressiveStage(0),setTimeout(()=>{this.loadProgressiveStage(1)},this.progressiveEnhancement.stages[1].delay),setTimeout(()=>{this.loadProgressiveStage(2)},this.progressiveEnhancement.stages[2].delay))},async loadProgressiveStage(e){if(e<=this.progressiveEnhancement.currentStage)return;let t=this.progressiveEnhancement.stages[e];if(t.loaded)return;let i=performance.now();try{await this.loadStageFeatures(t.features),t.loaded=!0,this.progressiveEnhancement.currentStage=e;let s=performance.now()-i;this.progressiveEnhancement.performanceMetrics.stageLoadTimes[t.name]=s,s>10&&console.log(`Progressive stage ${e} loaded in ${s.toFixed(2)}ms`),this.onProgressiveStageLoaded(e)}catch(s){console.error(`Failed to load progressive stage ${e}:`,s)}},async loadStageFeatures(e){let t=e.map(i=>this.loadFeature(i));await Promise.allSettled(t)},async loadFeature(e){try{switch(e){case"basicEditing":break;case"syntaxHighlighting":await this.loadSyntaxHighlighting();break;case"basicTheme":await this.loadBasicTheme();break;case"autocompletion":await this.loadAutocompletion();break;case"findReplace":await this.loadFindReplace();break;case"toolbar":await this.loadToolbar();break;case"languageTools":await this.loadLanguageTools();break;case"customCompletions":await this.loadCustomCompletionsEnhanced();break;case"statusBar":await this.loadStatusBarProgressive();break;case"virtualScrolling":await this.loadVirtualScrollingProgressive();break;case"advancedExtensions":await this.loadAdvancedExtensionsProgressive();break;default:console.warn(`Unknown progressive feature: ${e}`)}}catch(t){console.error(`Failed to load feature ${e}:`,t)}},async loadSyntaxHighlighting(){if(!this.editor||!this.editor.session)return;let e=this.editor.session,t=this.detectCodeMode(this.state||"");t&&e.setMode(`ace/mode/${t}`)},async loadBasicTheme(){if(!this.editor)return;let e=this.shouldUseDarkTheme();this.editor.setTheme(e?this.darkTheme:this.options.theme||"ace/theme/eclipse")},async loadAutocompletion(){this.editor&&this.editor.setOptions({enableBasicAutocompletion:!0,enableLiveAutocompletion:!0,liveAutocompletionDelay:500,liveAutocompletionThreshold:3})},async loadFindReplace(){this.editor},async loadToolbar(){this.hasToolbar&&!this.toolbarState.isInitialized&&typeof this.initToolbar=="function"&&this.initToolbar()},async loadLanguageTools(){this.editor&&this.editor.setOptions({enableSnippets:!0,enableInlineAutocompletion:!0})},async loadCustomCompletionsEnhanced(){this.enableCustomCompletions&&this.completions.length>0&&await this.setupCustomCompletions()},async loadStatusBarProgressive(){this.showStatusBar&&!this.statusBarElement&&await this.initStatusBar()},async loadVirtualScrollingProgressive(){this.editor&&this.editor.session&&this.editor.session.getLength()>this.virtualScrolling.threshold&&this.setupVirtualScrolling()},async loadAdvancedExtensionsProgressive(){},onProgressiveStageLoaded(e){let t=this.progressiveEnhancement.stages[e];switch(e){case 1:this.showProgressiveIndicators("intermediate");break;case 2:this.showProgressiveIndicators("advanced");break}this.$root.dispatchEvent(new CustomEvent("ace:stage-loaded",{detail:{stage:e,features:t.features}}))},showProgressiveIndicators(e){let t=this.$root.querySelector(".ace-loading-indicator");t&&(e==="intermediate"?t.textContent="Loading advanced features...":e==="advanced"&&(t.style.display="none"))},detectCodeMode(e){return e.includes("<?php")||e.includes("<?=")?"php":e.includes("function ")||e.includes("const ")||e.includes("let ")?"javascript":e.includes("{")&&e.includes("}")&&e.includes(":")?"css":e.trim().startsWith("{")&&e.trim().endsWith("}")?"json":"text"},shouldUseDarkTheme(){return this.disableDarkTheme?!1:document.documentElement.classList.contains("dark")||window.matchMedia("(prefers-color-scheme: dark)").matches},async initializeEditor(){try{await this.loadScript(L);let e=this.preloadCriticalExtensions();await this.loadExtensionsEnhanced(),await e,Object.entries(F).forEach(([i,s])=>{ace.config.set(i,s)}),this.editor=ace.edit(this.$refs.aceCodeEditorInner);let t={animatedScroll:!1,showPrintMargin:!1,fadeFoldWidgets:!1,displayIndentGuides:!1,highlightGutterLine:!1,showInvisibles:!1,enableBasicAutocompletion:!1,enableLiveAutocompletion:!1,enableSnippets:!1,...m,fontSize:this.currentFontSize,showGutter:m.showGutter!==!1,showLineNumbers:m.showLineNumbers!==!1};this.editor.setOptions(t),t.cursorStyle&&setTimeout(()=>{this.editor.getOption("cursorStyle")!==t.cursorStyle&&(console.warn("\u26A0\uFE0F CursorStyle mismatch! Trying direct setOption..."),this.editor.setOption("cursorStyle",t.cursorStyle))},100),this.changeWordWrap(this.currentWordWrap),this.applyOverscrollSettings(),this.editor.session.setValue(this.state||w),this.applyInitialTheme(),this.observeDarkModeChanges(),this.setupPerformanceOptimizations(),this.setupReliabilityImprovements(),this.$watch("state",Alpine.debounce(()=>{if(!(this.isDestroyed||!this.editor)){if(!this.shouldUpdateState){this.shouldUpdateState=!0;return}this.editor.isFocused()||this.editor.session.setValue(this.state||w)}},100)),this.editor.session.on("change",Alpine.debounce(()=>{if(this.isDestroyed||!this.editor)return;let i=this.editor.getValue();this.state=i,this.shouldUpdateState=!1,this.updateToolbarState(!1)},50)),this.initializeExpensiveStateCache(),this.optimizeUndoManager(),setTimeout(()=>{this.progressiveEnhancement.currentStage>=1&&this.updateToolbarState()},50),this.initAccessibility(),this.setupVirtualScrolling(),this.initProgressiveEnhancement()}catch(e){console.error("ACE Editor initialization failed:",e),this.handleInitializationError(e)}},handleInitializationError(e){console.error("ACE Editor initialization failed, falling back to basic textarea:",e);let t=this.$refs?.aceCodeEditorInner;t&&(t.innerHTML=`
                    <div class="fi-ace-editor-fallback">
                        <div class="fi-ace-editor-error-banner">
                            <div class="flex items-center gap-2 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                                <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 15.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                                <div>
                                    <p class="text-sm font-medium text-yellow-800">Code editor loaded in basic mode</p>
                                    <p class="text-xs text-yellow-600">Advanced features are temporarily unavailable</p>
                                </div>
                            </div>
                        </div>
                        <textarea
                            x-model="state"
                            placeholder="${this.placeholder}"
                            class="fi-input w-full min-h-[200px] font-mono text-sm"
                            rows="15"
                            ${this.isDisabled?"disabled":""}
                        ></textarea>
                        <details class="mt-2 text-xs text-gray-500">
                            <summary class="cursor-pointer hover:text-gray-700">Technical Details</summary>
                            <pre class="mt-1 p-2 bg-gray-50 rounded text-xs overflow-auto">${e.message||"Unknown error occurred"}</pre>
                        </details>
                    </div>
                `),this.isFallbackMode=!0,this.editor=null},async loadScriptWithRetry(e,t=null,i=null){t=t||this.extensionLoadingConfig.maxRetries||3,i=i||this.extensionLoadingConfig.retryDelay||1e3;for(let s=1;s<=t;s++)try{await this.loadScript(e);return}catch(r){if(console.warn(`Attempt ${s} failed to load script: ${e}`,r),s===t)throw new Error(`Failed to load script after ${t} attempts: ${e}`);await new Promise(o=>setTimeout(o,i))}},async loadExtensionsEnhanced(){if(!p||Object.keys(p).length===0)return;let e=Object.entries(p),t=this.extensionLoadingConfig.parallelLoading!==!1,i=this.extensionLoadingConfig.maxRetries||3,s=this.extensionLoadingConfig.timeout||3e4,r=e.map(async([c,u])=>{if(this.extensionCache.preloaded.has(c))return{name:c,url:u,status:"preloaded"};let f=this.getExtensionFromCache(c);if(f)try{return this.executeCachedScript(f,c),{name:c,url:u,status:"cached"}}catch(g){console.warn(`Failed to execute cached extension: ${c}`,g)}try{return await this.loadScriptWithRetry(u,i),{name:c,url:u,status:"loaded"}}catch(g){return console.error(`Failed to load extension: ${c}`,g),{name:c,url:u,status:"failed",error:g}}}),o;if(t)o=await Promise.allSettled(r);else{o=[];for(let c of r){let u=await Promise.allSettled([c]);o.push(u[0])}}let n=o.filter(c=>["loaded","preloaded","cached"].includes(c.value?.status)).map(c=>c.value.name),l=o.filter(c=>c.value?.status==="failed").map(c=>c.value),a=o.filter(c=>c.value?.status==="preloaded").length,d=o.filter(c=>c.value?.status==="cached").length,b=o.filter(c=>c.value?.status==="loaded").length;return(a>0||d>0)&&console.log(`Extension loading performance: ${a} preloaded, ${d} cached, ${b} from network`),l.length>0&&(console.error(`Failed to load extensions: ${l.map(c=>c.name).join(", ")}`),l.forEach(c=>{console.error(`Extension ${c.name} error:`,c.error)})),n},getExtensionLoadingStats(){let e=Object.entries(p||{}),t=e.length,i=e.map(([r,o])=>o),s=this.loadedScripts.filter(r=>i.some(o=>r.includes(o.split("/").pop()))).length;return{total:t,loaded:s,pending:Math.max(0,t-s),successRate:t>0?Math.min(100,s/t*100).toFixed(1):0}},async preloadCriticalExtensions(){if(!p||Object.keys(p).length===0)return;let t=["language_tools","searchbox","beautify"].filter(o=>p[o]&&!this.extensionCache.preloaded.has(o));if(t.length===0)return;console.log(`Preloading ${t.length} critical extensions...`);let i=t.map(async o=>{let n=p[o];if(this.getExtensionFromCache(o))return this.extensionCache.preloaded.add(o),{name:o,status:"cached",source:"localStorage"};try{if(!this.extensionCache.preloadingPromises.has(o)){let a=this.loadScriptWithCache(n,o);this.extensionCache.preloadingPromises.set(o,a)}return await this.extensionCache.preloadingPromises.get(o),this.extensionCache.preloaded.add(o),{name:o,status:"preloaded",source:"network"}}catch(a){return console.warn(`Failed to preload extension: ${o}`,a),{name:o,status:"failed",error:a}}}),r=(await Promise.allSettled(i)).filter(o=>o.value?.status!=="failed");console.log(`Preloaded ${r.length}/${t.length} extensions successfully`)},async loadScriptWithCache(e,t){let i=this.getExtensionFromCache(t);if(i){this.executeCachedScript(i,t);return}await this.loadScript(e);try{let r=await(await fetch(e)).text();this.cacheExtension(t,r)}catch(s){console.warn(`Failed to cache extension: ${t}`,s)}},getExtensionFromCache(e){try{let t=`ace-extension-${e}`,i=localStorage.getItem(t);if(!i)return null;let s=JSON.parse(i);return s.version!==this.extensionCache.cacheVersion||Date.now()-s.timestamp>10080*60*1e3?(localStorage.removeItem(t),null):s.content}catch(t){return console.warn(`Cache read error for ${e}:`,t),null}},cacheExtension(e,t){try{let i=`ace-extension-${e}`,s={version:this.extensionCache.cacheVersion,timestamp:Date.now(),content:t};localStorage.setItem(i,JSON.stringify(s)),this.extensionCache.cached.set(e,s)}catch(i){if(i.name==="QuotaExceededError"){this.cleanExtensionCache();try{localStorage.setItem(cacheKey,JSON.stringify(cacheData))}catch(s){console.warn(`Failed to cache extension ${e}:`,s)}}}},cleanExtensionCache(){let i=Object.keys(localStorage).filter(r=>r.startsWith("ace-extension-")).map(r=>{try{let o=JSON.parse(localStorage.getItem(r));return{key:r,timestamp:o.timestamp}}catch{return{key:r,timestamp:0}}}).sort((r,o)=>r.timestamp-o.timestamp),s=Math.ceil(i.length*.25);for(let r=0;r<s;r++)localStorage.removeItem(i[r].key)},executeCachedScript(e,t){try{let i=document.createElement("script");i.textContent=e,i.setAttribute("data-cached-extension",t),document.head.appendChild(i),this.loadedScripts.push(`cached:${t}`)}catch(i){throw console.error(`Failed to execute cached script for ${t}:`,i),i}},clearExtensionCache(){try{Object.keys(localStorage).filter(i=>i.startsWith("ace-extension-")).forEach(i=>localStorage.removeItem(i)),this.extensionCache.cached.clear(),this.extensionCache.preloaded.clear(),console.log("Extension cache cleared")}catch(e){console.error("Failed to clear extension cache:",e)}},loadScript(e){return new Promise((t,i)=>{if(this.loadedScripts.includes(e)){t();return}let s=document.createElement("script");s.src=e,s.onload=()=>{this.loadedScripts.push(e),t()},s.onerror=i,document.head.appendChild(s)})},applyInitialTheme(){y?this.editor&&this.editor.setTheme(m.theme):this.setTheme()},observeDarkModeChanges(){if(y)return;let e=document.querySelector("html");this.observer=new MutationObserver(()=>this.setTheme()),this.observer.observe(e,{attributes:!0,attributeFilter:["class"]})},setTheme(){if(!this.editor)return;let t=document.querySelector("html").classList.contains("dark")&&v||m.theme;this.editor.setTheme(t)},setupCustomCompletions(){if(!this.editor)return;this.editor.setOptions({enableBasicAutocompletion:!0,enableLiveAutocompletion:!0,enableSnippets:!0});let e=ace.require("ace/ext/language_tools");if(this.completions&&this.completions.length>0){let t=this,i={getCompletions:function(s,r,o,n,l){let a=[];t.completions.forEach(d=>{a.push({caption:d.caption,value:d.value,meta:d.meta||"Custom",score:d.score||1e3})}),l(null,a)}};e.addCompleter(i)}this.snippets&&this.snippets.length>0&&Object.keys(this.snippets).forEach(t=>{let i=this.snippets[t];e.addSnippet({name:t,trigger:t,content:i})})},executeToolbarAction(e,t){if(!this.editor||!this.hasToolbar)return;t&&(t.preventDefault(),t.stopPropagation());let s={undo:()=>this.performOptimizedUndo(),redo:()=>this.performOptimizedRedo(),find:()=>this.editor.execCommand("find"),replace:()=>this.editor.execCommand("replace"),"goto-line":()=>this.goToLine(),"toggle-comment":()=>this.toggleCommentLines(),"toggle-fold":()=>this.toggleCurrentFold(),"show-invisibles":()=>this.toggleShowInvisibles(),"toggle-wordwrap":()=>this.toggleWordWrap(),"convert-uppercase":()=>this.convertToUpperCase(),"convert-lowercase":()=>this.convertToLowerCase(),"toggle-print-margin":()=>this.togglePrintMargin()}[e];s&&(s(),this.updateToolbarState())},toggleCurrentFold(){let e=this.editor.getSession(),t=this.editor.getCursorPosition(),i=this.getEfficientFoldState();try{if(!(e.getFoldWidget&&typeof e.getFoldWidget=="function")){this.editor.execCommand("toggleFoldWidget");return}if(i.isInsideFold){let o=e.getFoldAt?e.getFoldAt(t.row,t.column,1):null;if(o)e.unfold(o);else if(e.isRowFolded&&e.isRowFolded(t.row)){let n=e.getFoldWidgetRange?e.getFoldWidgetRange(t.row,"all"):null;n&&e.unfold(n)}return}let r=e.getFoldWidget(t.row);if(r==="start"){let o=e.getFoldWidgetRange?e.getFoldWidgetRange(t.row,"all"):null;o&&((e.isRowFolded?e.isRowFolded(t.row):!1)?e.unfold(o):e.addFold("...",o))}else if(r==="end"){let o=e.getFoldWidgetRange?e.getFoldWidgetRange(t.row,"all"):null;o&&e.unfold(o)}else{let o=t.row-1,n=10;for(;o>=0&&n>0;){if(e.getFoldWidget(o)==="start"){let a=e.getFoldWidgetRange?e.getFoldWidgetRange(o,"all"):null;if(a){(e.isRowFolded?e.isRowFolded(o):!1)?e.unfold(a):e.addFold("...",a);break}}o--,n--}}this.lastFoldState.cursorRow=-1,this.lastFoldState.cursorColumn=-1}catch(s){console.error("Error toggling fold:",s);try{this.editor.execCommand("toggleFoldWidget"),this.lastFoldState.cursorRow=-1,this.lastFoldState.cursorColumn=-1}catch(r){console.error("Fallback fold command failed:",r)}}},toggleCommentLines(){let e=this.editor,t=e.getSession(),i=e.getSelection(),s=i.getRange();if(s.isEmpty()){let r=i.getCursor().row;this.toggleLineComment(t,r,r)}else this.toggleLineComment(t,s.start.row,s.end.row)},toggleLineComment(e,t,i){let s=this.getCommentPrefix(e);if(!s)return;let r=s.prefix,o=s.suffix||"",n=!0;for(let l=t;l<=i;l++){let a=e.getLine(l);if(a.trim()&&!a.trim().startsWith(r)){n=!1;break}}for(let l=t;l<=i;l++){let a=e.getLine(l);if(n){let d=a;o?d=a.replace(new RegExp(`^\\s*${r}\\s*(.*?)\\s*${o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\s?$`),"$1"):d=a.replace(new RegExp(`^\\s*${r}\\s?`),""),e.replace({start:{row:l,column:0},end:{row:l,column:a.length}},d)}else{let d;o?d=r+" "+a+" "+o:d=r+" "+a,e.replace({start:{row:l,column:0},end:{row:l,column:a.length}},d)}}},getCommentPrefix(e){let t=e.getMode().$id;return{"ace/mode/php":{prefix:"//",suffix:""},"ace/mode/javascript":{prefix:"//",suffix:""},"ace/mode/typescript":{prefix:"//",suffix:""},"ace/mode/java":{prefix:"//",suffix:""},"ace/mode/c_cpp":{prefix:"//",suffix:""},"ace/mode/csharp":{prefix:"//",suffix:""},"ace/mode/python":{prefix:"#",suffix:""},"ace/mode/ruby":{prefix:"#",suffix:""},"ace/mode/perl":{prefix:"#",suffix:""},"ace/mode/sh":{prefix:"#",suffix:""},"ace/mode/bash":{prefix:"#",suffix:""},"ace/mode/sql":{prefix:"--",suffix:""},"ace/mode/html":{prefix:"<!--",suffix:"-->"},"ace/mode/xml":{prefix:"<!--",suffix:"-->"},"ace/mode/css":{prefix:"/*",suffix:"*/"},"ace/mode/scss":{prefix:"//",suffix:""},"ace/mode/sass":{prefix:"//",suffix:""},"ace/mode/less":{prefix:"//",suffix:""}}[t]||{prefix:"//",suffix:""}},toggleShowInvisibles(e="all"){let t=this.editor.getShowInvisibles(),i;switch(e){case"all":i=!t;break;case"spaces":i=t==="spaces"?!1:"spaces";break;case"tabs":i=t==="tabs"?!1:"tabs";break;case"eol":i=t==="eol"?!1:"eol";break;default:i=!t}this.editor.setShowInvisibles(i),this.lastExpensiveState.showInvisibles=i,this.lastExpensiveState.lastCheckTime=Date.now(),this.updateToolbarState(!0)},toggleWordWrap(){let e=this.editor.getSession(),t=e.getUseWrapMode();e.setUseWrapMode(!t),this.updateToolbarState()},convertToUpperCase(){this.convertCaseOptimized("toUpperCase")},convertToLowerCase(){this.convertCaseOptimized("toLowerCase")},convertCaseOptimized(e){let t=performance.now(),i=this.caseConversionState;if(!i.operationInProgress){i.operationInProgress=!0;try{let s=this.editor.getSession(),r=this.editor.getSelectionRange();this.editor.getSelection().isEmpty()&&this.editor.getSelection().selectWord();let o=this.editor.getSelectionRange(),n=s.getTextRange(o);if(!n||n.length===0){this.editor.getSelection().setSelectionRange(r);return}let l=`${n}:${e}`;if(i.conversionCache.has(l)){let a=i.conversionCache.get(l);s.replace(o,a),this.editor.getSelection().setSelectionRange(r);return}if(n.length>i.largeTextThreshold)this.performLargeTextConversion(o,n,e,r,l);else{let a=e==="toUpperCase"?n.toUpperCase():n.toLowerCase();this.performOptimizedReplacement(o,a,r,l)}}catch(s){console.warn(`Case conversion failed (${e}):`,s),this.editor.execCommand(e.toLowerCase())}finally{i.operationInProgress=!1,i.lastConversionTime=performance.now()}}},performLargeTextConversion(e,t,i,s,r){requestAnimationFrame(()=>{try{let o=i==="toUpperCase"?t.toUpperCase():t.toLowerCase();this.performOptimizedReplacement(e,o,s,r)}catch(o){console.warn("Large text conversion failed:",o),this.editor.execCommand(i.toLowerCase())}})},performOptimizedReplacement(e,t,i,s){let r=this.editor.getSession(),o=r.mergeUndoDeltas;r.mergeUndoDeltas="always";try{r.replace(e,t),this.editor.getSelection().setSelectionRange(i),this.cacheConversionResult(s,t)}finally{r.mergeUndoDeltas=o}},cacheConversionResult(e,t){let i=this.caseConversionState;if(i.conversionCache.size>=i.maxCacheSize){let s=i.conversionCache.keys().next().value;i.conversionCache.delete(s)}i.conversionCache.set(e,t)},togglePrintMargin(){let t=!this.printMarginState.showPrintMargin;this.setPrintMarginOptimized(t),this.updateToolbarState(!0)},setPrintMarginOptimized(e){if(this.printMarginState.showPrintMargin===e)return;let t=performance.now();this.printMarginState.showPrintMargin=e,this.printMarginState.lastUpdateTime=t,this.printMarginState.throttledUpdate&&cancelAnimationFrame(this.printMarginState.throttledUpdate),this.printMarginState.throttledUpdate=requestAnimationFrame(()=>{try{this.editor.setShowPrintMargin(e),this.updateWordWrapForPrintMargin()}catch(i){console.warn("Print margin update failed:",i),this.editor.setShowPrintMargin(e)}finally{this.printMarginState.throttledUpdate=null,this.printMarginState.updateScheduled=!1}}),this.printMarginState.updateScheduled=!0},updateWordWrapForPrintMargin(){try{let e=this.editor.getSession();if(e&&e.getUseWrapMode()){let t=this.editor.renderer;t&&t.adjustWrapLimit&&t.adjustWrapLimit()}}catch{}},setPrintMarginColumn(e){e=Math.max(1,Math.min(e,1e3)),this.printMarginState.printMarginColumn!==e&&(this.printMarginState.printMarginColumn=e,this.printMarginState.throttledUpdate&&cancelAnimationFrame(this.printMarginState.throttledUpdate),this.printMarginState.throttledUpdate=requestAnimationFrame(()=>{try{this.editor.setPrintMarginColumn(e),this.updateWordWrapForPrintMargin()}catch(t){console.warn("Print margin column update failed:",t)}finally{this.printMarginState.throttledUpdate=null}}))},goToLine(){this.editor&&this.showOptimizedGotoLineDialog()},showOptimizedGotoLineDialog(){let e=this.editor.getSession(),t=this.editor.getCursorPosition().row+1,i=e.getLength(),s=document.documentElement.classList.contains("dark"),r=this.editor.container,o=this.createOptimizedModal(s),n=this.getOrCreateGotoLineDialog(t,i,s);o.appendChild(n),r.appendChild(o),this.setupGotoLineHandlers(o,n,t,i,s),requestAnimationFrame(()=>{let l=n.querySelector("#gotoLineInput");l&&(l.focus(),l.select())})},createOptimizedModal(e){let t=document.createElement("div");return t.style.cssText=`
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.3);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                backdrop-filter: blur(2px);
                transition: opacity 0.15s ease-out;
            `,t.style.opacity="0",requestAnimationFrame(()=>{t.style.opacity="1"}),t},getOrCreateGotoLineDialog(e,t,i){let s=Date.now(),r=this.dialogPool;return r.gotoLine&&s-r.lastUsed<r.reuseTimeout?(this.resetGotoLineDialog(r.gotoLine,e,i),r.lastUsed=s,r.gotoLine):(r.gotoLine=this.createGotoLineDialog(e,t,i),r.lastUsed=s,r.gotoLine)},resetGotoLineDialog(e,t,i){e.style.background=i?"#1f2937":"white",e.style.color=i?"white":"black",e.style.border=`1px solid ${i?"#374151":"#e5e7eb"}`;let s=e.querySelector("#gotoLineInput");s&&(s.value=t.toString(),s.style.borderColor=i?"#4b5563":"#d1d5db");let r=e.querySelector("#gotoHistory");r&&(r.innerHTML=this.gotoLineState.history.length>0?this.gotoLineState.history.slice(-5).map(o=>`<button class="history-btn" data-line="${o}" style="padding: 2px 8px; font-size: 11px; background: ${i?"#374151":"#f3f4f6"}; color: ${i?"#d1d5db":"#4b5563"}; border: 1px solid ${i?"#4b5563":"#d1d5db"}; border-radius: 3px; cursor: pointer; font-family: monospace;">${o}</button>`).join(""):""),e.style.transform="scale(0.95)",e.style.opacity="0"},createGotoLineDialog(e,t,i){let s=document.createElement("div");s.style.cssText=`
                background: ${i?"#1f2937":"white"};
                color: ${i?"white":"black"};
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
                min-width: 320px;
                max-width: 360px;
                border: 1px solid ${i?"#374151":"#e5e7eb"};
                transform: scale(0.95);
                opacity: 0;
                transition: all 0.15s ease-out;
            `;let r=this.gotoLineState.history.length>0?`<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid ${i?"#374151":"#e5e7eb"};">
                    <div style="font-size: 11px; color: ${i?"#9ca3af":"#666"}; margin-bottom: 6px;">Recent:</div>
                    <div id="gotoHistory" style="display: flex; flex-wrap: wrap; gap: 4px;">
                        ${this.gotoLineState.history.slice(-5).map(o=>`<button class="history-btn" data-line="${o}" style="padding: 2px 8px; font-size: 11px; background: ${i?"#374151":"#f3f4f6"}; color: ${i?"#d1d5db":"#4b5563"}; border: 1px solid ${i?"#4b5563":"#d1d5db"}; border-radius: 3px; cursor: pointer; font-family: monospace;">${o}</button>`).join("")}
                    </div>
                </div>`:"";return s.innerHTML=`
                <div style="margin-bottom: 16px;">
                    <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600; color: ${i?"white":"#111827"};">Go to Line</h3>
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <label style="font-size: 13px; font-weight: 500; white-space: nowrap; color: ${i?"#d1d5db":"#374151"};">Line:</label>
                        <input type="text"
                               id="gotoLineInput"
                               inputmode="numeric"
                               pattern="[0-9]*"
                               value="${e}"
                               style="flex: 1; padding: 6px 10px; border: 2px solid ${i?"#4b5563":"#d1d5db"}; background: ${i?"#374151":"white"}; color: ${i?"white":"black"}; border-radius: 4px; font-size: 14px; font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace; min-width: 80px; outline: none; transition: border-color 0.15s ease;"
                               placeholder="1"
                               autocomplete="off">
                        <span style="font-size: 12px; color: ${i?"#9ca3af":"#6b7280"};">of ${t}</span>
                    </div>
                    <div id="inputFeedback" style="font-size: 11px; color: ${i?"#f87171":"#dc2626"}; min-height: 16px; opacity: 0; transition: opacity 0.15s ease;">Invalid line number</div>
                </div>
                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                    <button id="gotoLineCancel"
                            style="padding: 6px 14px; border: 1px solid ${i?"#4b5563":"#d1d5db"}; background: ${i?"#374151":"white"}; color: ${i?"white":"black"}; border-radius: 4px; cursor: pointer; font-size: 13px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; transition: all 0.15s ease;">
                        Cancel
                    </button>
                    <button id="gotoLineGo"
                            style="padding: 6px 14px; border: 1px solid #2563eb; background: #2563eb; color: white; border-radius: 4px; cursor: pointer; font-size: 13px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; transition: all 0.15s ease; font-weight: 500;">
                        Go to Line
                    </button>
                </div>
                ${r}
            `,requestAnimationFrame(()=>{s.style.transform="scale(1)",s.style.opacity="1"}),s},setupGotoLineHandlers(e,t,i,s,r){let o=t.querySelector("#gotoLineInput"),n=t.querySelector("#gotoLineGo"),l=t.querySelector("#gotoLineCancel"),a=t.querySelector("#inputFeedback"),d=t.querySelectorAll(".history-btn"),b=()=>{let h=o.value.trim(),S=this.parseGotoLineInput(h);S.isValid?(this.addToGotoHistory(S.line),this.performOptimizedGotoLine(S.line,S.column,!0),this.editor.focus(),u()):c(S.error)},c=h=>{a.textContent=h,a.style.opacity="1",o.style.borderColor=r?"#f87171":"#dc2626",setTimeout(()=>{a.style.opacity="0",o.style.borderColor=r?"#4b5563":"#d1d5db"},2e3)},u=()=>{t.style.transform="scale(0.95)",t.style.opacity="0",e.style.opacity="0",setTimeout(()=>{this.cleanupGotoLineDialog(e),this.editor.focus()},150)},f=()=>{u()},g,C=()=>{clearTimeout(g),g=setTimeout(()=>{let h=this.parseGotoLineInput(o.value.trim());n.style.opacity=h.isValid?"1":"0.6",n.disabled=!h.isValid,h.isValid?(o.style.borderColor=r?"#10b981":"#059669",a.style.opacity="0"):o.value.trim()&&(o.style.borderColor=r?"#4b5563":"#d1d5db",a.style.opacity="0")},150)};o.addEventListener("input",C),o.addEventListener("keydown",h=>{if(h.key==="Enter")return h.preventDefault(),h.stopPropagation(),b(),!1;if(h.key==="Escape")return h.preventDefault(),h.stopPropagation(),f(),!1}),d.forEach(h=>{h.addEventListener("click",()=>{let S=h.dataset.line;o.value=S,C(),o.focus()})}),n.addEventListener("click",b),l.addEventListener("click",f),e.addEventListener("click",h=>{h.target===e&&f()});let x=h=>{if((h.key==="Enter"||h.key==="Escape")&&e.parentNode)return h.preventDefault(),h.stopPropagation(),h.key==="Enter"?b():f(),!1};document.addEventListener("keydown",x,!0),e._cleanup=()=>{document.removeEventListener("keydown",x,!0),clearTimeout(g)}},parseGotoLineInput(e){let i=this.editor.getSession().getLength();if(!e)return{isValid:!1,error:"Please enter a line number"};let s,r=0,o=e.match(/^(\d+)([:>])(\d*)$/);if(o)s=parseInt(o[1],10),o[3]&&(r=parseInt(o[3],10));else if(e.toLowerCase().startsWith("c")){let n=parseInt(e.slice(1),10);return{isValid:!0,line:Math.max(1,Math.floor(n/80)),column:0}}else s=parseInt(e,10);return isNaN(s)||s<1||s>i?{isValid:!1,error:`Line must be between 1 and ${i}`}:((isNaN(r)||r<0)&&(r=0),{isValid:!0,line:s,column:r})},performOptimizedGotoLine(e,t,i=!0){try{this.gotoLineState.animationFrame&&cancelAnimationFrame(this.gotoLineState.animationFrame),this.gotoLineState.animationFrame=requestAnimationFrame(()=>{this.editor.clearSelection(),this.editor.getSession().unfold({row:e-1,column:t||0}),this.editor.moveCursorTo(e-1,t||0),this.editor.isRowFullyVisible(e-1)||this.editor.scrollToLine(e-1,!0,i),this.gotoLineState.lastGotoLine=e,this.gotoLineState.animationFrame=null})}catch(s){console.warn("Goto line operation failed:",s),this.editor.gotoLine(e,t,i)}},addToGotoHistory(e){let t=this.gotoLineState.history.indexOf(e);t>-1&&this.gotoLineState.history.splice(t,1),this.gotoLineState.history.push(e),this.gotoLineState.history.length>this.gotoLineState.maxHistory&&this.gotoLineState.history.shift()},cleanupGotoLineDialog(e){e.parentNode&&e.parentNode.removeChild(e),e._cleanup&&(e._cleanup(),e._cleanup=null),this.gotoLineState.animationFrame&&(cancelAnimationFrame(this.gotoLineState.animationFrame),this.gotoLineState.animationFrame=null)},toggleFullscreen(){this.isFullscreen=!this.isFullscreen;let e=this.$el.closest(".rd-ace-editor");this.isFullscreen?(e.classList.add("rd-ace-editor--fullscreen"),document.body.style.overflow="hidden"):(e.classList.remove("rd-ace-editor--fullscreen"),document.body.style.overflow=""),setTimeout(()=>{this.editor&&!this.isDestroyed&&(this.editor.resize(),this.isFullscreen&&this.editor.renderer.updateFull())},100)},initializeExpensiveStateCache(){if(this.editor)try{this.lastExpensiveState.showInvisibles=this.editor.getShowInvisibles(),this.lastExpensiveState.lastCheckTime=Date.now(),this.printMarginState.showPrintMargin=this.editor.getShowPrintMargin(),this.printMarginState.printMarginColumn=this.editor.getPrintMarginColumn()||80,this.printMarginState.lastUpdateTime=Date.now();let e=this.editor.session.getUndoManager();this.lastToolbarState.canUndo=e.hasUndo(),this.lastToolbarState.canRedo=e.hasRedo(),this.undoRedoState.canUndo=this.lastToolbarState.canUndo,this.undoRedoState.canRedo=this.lastToolbarState.canRedo,this.undoRedoState.lastCheckTime=Date.now(),this.lastToolbarState.showPrintMargin=this.printMarginState.showPrintMargin,this.lastToolbarState.showInvisibles=this.lastExpensiveState.showInvisibles,this.lastToolbarState.wordWrapEnabled=this.editor.getSession().getUseWrapMode(),this.toolbarState.canUndo=this.lastToolbarState.canUndo,this.toolbarState.canRedo=this.lastToolbarState.canRedo,this.toolbarState.showPrintMargin=this.lastToolbarState.showPrintMargin,this.toolbarState.showInvisibles=this.lastToolbarState.showInvisibles,this.toolbarState.wordWrapEnabled=this.lastToolbarState.wordWrapEnabled}catch(e){console.warn("Failed to initialize expensive state cache:",e),this.lastExpensiveState.showInvisibles=!1,this.lastExpensiveState.lastCheckTime=Date.now(),this.printMarginState.showPrintMargin=!0,this.printMarginState.printMarginColumn=80,this.printMarginState.lastUpdateTime=Date.now()}},performOptimizedUndo(){if(!(!this.editor||!this.editor.session))try{let e=this.editor.session.getUndoManager();if(!e||!e.hasUndo())return;let t=performance.now();if(t-this.undoRedoState.lastOperationTime<50&&this.undoRedoState.isProcessingQueue){this.undoRedoState.operationQueue.push({type:"undo",timestamp:t});return}this.undoRedoState.lastOperationTime=t,this.undoRedoState.isProcessingQueue=!0,requestAnimationFrame(()=>{try{this.editor.undo(),this.undoRedoState.lastCheckTime=0,this.updateToolbarState(!0),this.processUndoRedoQueue()}catch(s){console.warn("Undo operation failed:",s)}finally{this.undoRedoState.isProcessingQueue=!1}})}catch(e){console.warn("Undo operation failed:",e);try{this.editor.undo(),this.updateToolbarState(!0)}catch(t){console.warn("Fallback undo also failed:",t)}}},performOptimizedRedo(){if(!(!this.editor||!this.editor.session))try{let e=this.editor.session.getUndoManager();if(!e||!e.hasRedo())return;let t=performance.now();if(t-this.undoRedoState.lastOperationTime<50&&this.undoRedoState.isProcessingQueue){this.undoRedoState.operationQueue.push({type:"redo",timestamp:t});return}this.undoRedoState.lastOperationTime=t,this.undoRedoState.isProcessingQueue=!0,requestAnimationFrame(()=>{try{this.editor.redo(),this.undoRedoState.lastCheckTime=0,this.updateToolbarState(!0),this.processUndoRedoQueue()}catch(s){console.warn("Redo operation failed:",s)}finally{this.undoRedoState.isProcessingQueue=!1}})}catch(e){console.warn("Redo operation failed:",e);try{this.editor.redo(),this.updateToolbarState(!0)}catch(t){console.warn("Fallback redo also failed:",t)}}},processUndoRedoQueue(){if(this.undoRedoState.operationQueue.length===0)return;let e=this.undoRedoState.operationQueue,t=e.filter(s=>s.type==="undo").pop(),i=e.filter(s=>s.type==="redo").pop();this.undoRedoState.operationQueue=[],setTimeout(()=>{t&&this.canPerformUndo()?this.performOptimizedUndo():i&&this.canPerformRedo()&&this.performOptimizedRedo()},100)},canPerformUndo(){let e=Date.now();if(e-this.undoRedoState.lastCheckTime<this.undoRedoState.checkCacheTimeout)return this.undoRedoState.canUndo;try{let i=this.editor.session.getUndoManager(),s=i?i.hasUndo():!1;return this.undoRedoState.canUndo=s,this.undoRedoState.lastCheckTime=e,s}catch{return!1}},canPerformRedo(){let e=Date.now();if(e-this.undoRedoState.lastCheckTime<this.undoRedoState.checkCacheTimeout)return this.undoRedoState.canRedo;try{let i=this.editor.session.getUndoManager(),s=i?i.hasRedo():!1;return this.undoRedoState.canRedo=s,this.undoRedoState.lastCheckTime=e,s}catch{return!1}},optimizeUndoManager(){if(!(!this.editor||!this.editor.session))try{let e=this.editor.session.getUndoManager();if(!e)return;e.$undoDepth===1/0&&(e.$undoDepth=200),this.editor.session.mergeUndoDeltas!=="always"&&(this.editor.session.mergeUndoDeltas="always"),this.undoRedoState.undoDepth=e.$undoStack?e.$undoStack.length:0,this.undoRedoState.redoDepth=e.$redoStack?e.$redoStack.length:0}catch(e){console.warn("Failed to optimize undo manager:",e)}},startBatchOperation(e="default"){let t=this.operationState;return t.isBatching||(t.isBatching=!0,t.currentOperation={type:e,startTime:performance.now(),changes:{...t.pendingChanges}},t.batchTimeout&&clearTimeout(t.batchTimeout)),t.currentOperation},endBatchOperation(){let e=this.operationState;if(!e.isBatching)return;if(!e.currentOperation){e.isBatching=!1;return}this.scheduleRenderFlush(),e.isBatching=!1,e.currentOperation=null},scheduleRenderFlush(){let e=this.operationState;e.batchTimeout||(e.batchTimeout=setTimeout(()=>{this.flushRenderChanges(),e.batchTimeout=null},e.batchDelay))},flushRenderChanges(){let e=this.operationState,t=e.pendingChanges,i=performance.now();if(i-e.lastRenderTime<16){this.scheduleRenderFlush();return}try{let s=0;t.cursor&&(s|=1),t.selection&&(s|=2),t.gutter&&(s|=4),t.scroll&&(s|=8),t.text&&(s|=16),(t.cursor||t.selection)&&(s|=32),this.editor&&this.editor.renderer&&this.editor.renderer.$loop&&this.editor.renderer.$loop.schedule(s),e.pendingChanges={cursor:!1,selection:!1,text:!1,scroll:!1,gutter:!1},e.lastRenderTime=i,e.renderChanges++}catch(s){console.warn("Render flush failed:",s)}},markChangePending(e){let t=this.operationState;t.pendingChanges.hasOwnProperty(e)&&(t.pendingChanges[e]=!0,t.isBatching||(this.startBatchOperation("auto"),setTimeout(()=>{t.isBatching&&t.currentOperation?.type==="auto"&&this.endBatchOperation()},0)))},setupPerformanceOptimizations(){if(this.editor)try{if(this.editor.session){this.optimizeUndoManager(),this.editor.session.mergeUndoDeltas=!0;let e=this.editor.session.getUndoManager();e&&e.$undoDepth===1/0&&(e.$undoDepth=200)}this.editor.renderer&&(this.editor.renderer.setAnimatedScroll(!0),this.editor.renderer.$optimizeFontRendering=!0)}catch(e){console.warn("Failed to setup performance optimizations:",e)}},setupReliabilityImprovements(){if(this.editor)try{this.setupErrorBoundaries(),this.setupPerformanceMonitoring(),this.setupGracefulDegradation()}catch(e){console.warn("Failed to setup reliability improvements:",e)}},setupErrorBoundaries(){let e=this.editor.setTheme.bind(this.editor);this.editor.setTheme=(...i)=>{try{return e(...i)}catch(s){return console.warn("Theme setting failed, using fallback:",s),e("ace/theme/textmate")}};let t=this.editor.setOptions.bind(this.editor);if(this.editor.setOptions=(...i)=>{try{return t(...i)}catch(s){return console.warn("Options setting failed, using defaults:",s),t({})}},this.editor.session){let i=this.editor.session.setValue.bind(this.editor.session);this.editor.session.setValue=(...s)=>{try{return i(...s)}catch(r){return console.warn("Session setValue failed:",r),i("")}}}},setupPerformanceMonitoring(){let e=0,t=0,i=this.editor.execCommand.bind(this.editor);this.editor.execCommand=(...s)=>{let r=performance.now();e++;try{let o=i(...s);return performance.now()-r>100&&t++,o}catch(o){return console.warn(`Command execution failed: ${s[0]}`,o),!1}},setInterval(()=>{e>0&&(e=0,t=0)},3e4)},setupGracefulDegradation(){Object.entries({animatedScroll:()=>{try{return this.editor.setOption("animatedScroll",!0),this.editor.getOption("animatedScroll")}catch{return this.editor.setOption("animatedScroll",!1),!1}},liveAutocompletion:()=>{try{return this.editor.setOption("enableLiveAutocompletion",!0),this.editor.getOption("enableLiveAutocompletion")}catch{return this.editor.setOption("enableLiveAutocompletion",!1),!1}}}).forEach(([t,i])=>{try{i()}catch(s){console.warn(`Feature test failed for ${t}:`,s)}})},performHealthCheck(){if(!this.editor)return{status:"error",message:"Editor not initialized"};try{let e={status:"healthy",checks:{}};e.checks.session=!!this.editor.session,e.checks.renderer=!!this.editor.renderer,e.checks.theme=!!this.editor.getTheme(),e.checks.mode=!!this.editor.session.getMode(),e.checks.document=!!this.editor.session.getDocument();let t=performance.now();this.editor.renderer.onResize(!1,!0),e.checks.responsive=performance.now()-t<50;let i=Object.values(e.checks).filter(s=>!s).length;return i>0&&(e.status="warning",e.message=`${i} health checks failed`),e}catch(e){return{status:"error",message:`Health check failed: ${e.message}`,error:e}}},attemptAutoRecovery(){try{return this.performHealthCheck().status==="error"?(console.warn("Attempting ACE editor auto-recovery..."),this.editor.session||(console.warn("Recreating session..."),this.editor.setSession(new ace.EditSession(""))),this.editor.getTheme()||(console.warn("Resetting theme..."),this.editor.setTheme("ace/theme/textmate")),this.editor.session.getMode()||(console.warn("Resetting mode..."),this.editor.session.setMode("ace/mode/text")),this.performHealthCheck().status!=="error"?!0:(console.error("ACE editor auto-recovery failed"),!1)):!0}catch(e){return console.error("Auto-recovery failed:",e),!1}},getButtonTitle(e){if(!this.hasToolbar||!e)return"";if(e==="toggle-fold"){let i=this.getEfficientFoldState();return i.isInsideFold||i.canUnfold?"Unfold Code (Ctrl+Alt+F)":i.canFold?"Fold Code (Ctrl+Alt+F)":"Fold/Unfold Code"}return{undo:"Undo (Ctrl+Z)",redo:"Redo (Ctrl+Y)",replace:"Find (Ctrl+F)","goto-line":"Go To Line (Ctrl+G)","toggle-comment":"Toggle Comment (Ctrl+/)","show-invisibles":"Show Invisible Characters","toggle-wordwrap":"Toggle Word Wrap","convert-uppercase":"Convert to Uppercase","convert-lowercase":"Convert to Lowercase","toggle-print-margin":"Toggle Print Margin"}[e]||e},getButtonDisabled(e){if(!this.editor)return!0;switch(e){case"undo":return!this.toolbarState.canUndo;case"redo":return!this.toolbarState.canRedo;default:return!1}},getButtonActiveState(e){if(!this.editor)return!1;switch(e){case"toggle-print-margin":return this.toolbarState.showPrintMargin;case"show-invisibles":return this.toolbarState.showInvisibles;case"toggle-wordwrap":return this.toolbarState.wordWrapEnabled;case"toggle-fold":let t=this.getEfficientFoldState();return t.canFold||t.canUnfold||t.isInsideFold;default:return!1}},getEfficientFoldState(){if(!this.editor||!this.editor.session)return{canFold:!1,canUnfold:!1,isInsideFold:!1};let e=this.editor.session,t=this.editor.getCursorPosition();if(this.lastFoldState.cursorRow===t.row&&this.lastFoldState.cursorColumn===t.column)return{canFold:this.lastFoldState.canFold,canUnfold:this.lastFoldState.canUnfold,isInsideFold:this.lastFoldState.isInsideFold};let i=!1,s=!1,r=!1;try{if(!(e.getFoldWidget&&typeof e.getFoldWidget=="function"))return{canFold:!1,canUnfold:!1,isInsideFold:!1};let n=e.isRowFolded?e.isRowFolded(t.row):!1,l=e.getFoldAt?e.getFoldAt(t.row,t.column,1):null,a=e.getFoldWidget(t.row);r=n||!!l,a==="start"&&!n&&e.getFoldWidgetRange&&e.getFoldWidgetRange(t.row,"all")&&(i=!0),(n||l||a==="start"&&n)&&(s=!0),a==="end"&&n&&(s=!0)}catch(o){return console.warn("Fold state detection error:",o),{canFold:!1,canUnfold:!1,isInsideFold:!1}}return this.lastFoldState={canFold:i,canUnfold:s,isInsideFold:r,cursorRow:t.row,cursorColumn:t.column},{canFold:i,canUnfold:s,isInsideFold:r}},updateToolbarState(e=!1){if(!this.editor||!this.hasToolbar)return;this.debounceTimers.toolbarUpdate&&clearTimeout(this.debounceTimers.toolbarUpdate);let t=e?10:30;this.debounceTimers.toolbarUpdate=setTimeout(()=>{if(this.isDestroyed||!this.editor)return;let i=this.canPerformUndo(),s=this.canPerformRedo(),r=this.printMarginState.showPrintMargin,o=this.editor.getSession().getUseWrapMode(),n,l=Date.now(),a=l-this.lastExpensiveState.lastCheckTime;e||a>500?(n=this.editor.getShowInvisibles(),this.lastExpensiveState.showInvisibles=n,this.lastExpensiveState.lastCheckTime=l):n=this.lastExpensiveState.showInvisibles,this.lastFoldState.cursorRow=-1,this.lastFoldState.cursorColumn=-1,(e||a>100)&&this.updateFoldButtonState(),(this.lastToolbarState.canUndo!==i||this.lastToolbarState.canRedo!==s||this.lastToolbarState.showPrintMargin!==r||this.lastToolbarState.showInvisibles!==n||this.lastToolbarState.wordWrapEnabled!==o)&&(this.lastToolbarState.canUndo=i,this.lastToolbarState.canRedo=s,this.lastToolbarState.showPrintMargin=r,this.lastToolbarState.showInvisibles=n,this.lastToolbarState.wordWrapEnabled=o,this.toolbarState.canUndo=i,this.toolbarState.canRedo=s,this.toolbarState.showPrintMargin=r,this.toolbarState.showInvisibles=n,this.toolbarState.wordWrapEnabled=o)},t)},updateFoldButtonState(){if(this.editor)try{let e=this.$el.querySelector('[data-button="toggle-fold"]');if(!e)return;let t=this.getEfficientFoldState();t.isInsideFold||t.canUnfold?e.classList.add("fold-state-unfold"):e.classList.remove("fold-state-unfold")}catch{}},handleKeyboardShortcuts(){let e=this.editor;e.commands.addCommand({name:"findReplace",bindKey:{win:"Ctrl-F",mac:"Cmd-F"},exec:()=>this.editor.execCommand("replace")}),e.commands.addCommand({name:"toggleFullscreen",bindKey:{win:"Ctrl-F11",mac:"Cmd-F11"},exec:()=>this.toggleFullscreen()}),e.commands.addCommand({name:"toggleFullscreenAlt",bindKey:{win:"Ctrl-Shift-F",mac:"Cmd-Shift-F"},exec:()=>this.toggleFullscreen()}),e.commands.addCommand({name:"exitFullscreen",bindKey:{win:"Esc",mac:"Esc"},exec:()=>{this.isFullscreen&&this.toggleFullscreen()}})},addGlobalFullscreenEscapeHandler(){this._globalEscapeHandler=e=>{e.key==="Escape"&&this.isFullscreen&&(e.preventDefault(),e.stopPropagation(),this.toggleFullscreen())},document.addEventListener("keydown",this._globalEscapeHandler,!0),this.eventListeners.push({element:document,type:"keydown",handler:this._globalEscapeHandler,options:{capture:!0}})},initToolbar(){this.hasToolbar&&(this.handleKeyboardShortcuts(),this.setupToolbarEventDelegation(),this.updateToolbarState(),this.editor.selection.on("changeCursor",()=>{this.updateToolbarState()}),this.editor.session.on("change",()=>{this.updateToolbarState()}),this.editor.session.on("changeFold",()=>{this.lastFoldState.cursorRow=-1,this.lastFoldState.cursorColumn=-1,this.updateToolbarState()}),this.editor.on("focus",()=>{this.updateToolbarState()}),this.editor.on("blur",()=>{this.updateToolbarState()}))},setupToolbarEventDelegation(){let e=this.$el.querySelector(".rd-ace-editor-toolbar");e&&(e.addEventListener("click",t=>{let i=t.target.closest("[data-button]");if(!i)return;let s=i.dataset.button;s&&this.executeToolbarAction(s,t)},{passive:!0}),this.eventListeners.push({element:e,type:"click",handler:null}))},initStatusBar(){this.editor&&(this.createStatusBar(),this.updateStatusBar(),this.editor.session.on("change",()=>this.updateStatusBar()),this.editor.selection.on("changeCursor",()=>this.updateStatusBar()),this.editor.session.on("changeMode",()=>this.updateStatusBar()))},createStatusBar(){let e=this.$el.querySelector(".rd-ace-editor-status");if(!e){e=document.createElement("div"),e.className="rd-ace-editor-status";let r=this.$el.closest(".rd-ace-editor");r&&r.appendChild(e)}this.statusBarElement=e,this.statusBarOptions.className&&(e.className=`rd-ace-editor-status ${this.statusBarOptions.className}`);let i={...{position:{show:!0,content:`<div class="rd-ace-editor-status-position">
                        <span>Line: <span class="line">1</span>, Col: <span class="column">1</span></span>
                        <span class="selection"></span>
                    </div>`},info:{show:!0,content:`<div class="rd-ace-editor-status-info">
                        <span class="mode">TEXT</span> |
                        <span class="length">0 chars</span>
                    </div>`}},...this.statusBarOptions.sections},s="";Object.entries(i).forEach(([r,o])=>{o.show!==!1&&(s+=o.content||"")}),e.innerHTML=s},updateStatusBar(){!this.editor||!this.statusBarElement||(this.debounceTimers.statusBarUpdate&&clearTimeout(this.debounceTimers.statusBarUpdate),this.debounceTimers.statusBarUpdate=setTimeout(()=>{if(this.isDestroyed||!this.statusBarElement)return;let e=this.editor.getCursorPosition(),t=this.editor.getSelection(),i=this.editor.getSession();this.statusBarElements.line||(this.statusBarElements.line=this.statusBarElement.querySelector(".line"),this.statusBarElements.column=this.statusBarElement.querySelector(".column"),this.statusBarElements.selection=this.statusBarElement.querySelector(".selection"),this.statusBarElements.mode=this.statusBarElement.querySelector(".mode"),this.statusBarElements.length=this.statusBarElement.querySelector(".length"));let s=e.row+1,r=e.column+1;this.statusBarElements.line&&this.statusBarElements.line.textContent!=s&&(this.statusBarElements.line.textContent=s),this.statusBarElements.column&&this.statusBarElements.column.textContent!=r&&(this.statusBarElements.column.textContent=r);let o=this.statusBarElements.selection;if(o){let a="";if(!t.isEmpty()){let d=t.getAllRanges().length;a=` (${d} line${d>1?"s":""} selected)`}o.textContent!==a&&(o.textContent=a)}let n=this.statusBarElements.mode;if(n){let d=(i.getMode().$id||"text").replace("ace/mode/","").toUpperCase();n.textContent!==d&&(n.textContent=d)}let l=this.statusBarElements.length;if(l){let a=i.getLength();if(this.statusBarState.lines!==a){let d=i.getValue().length;l.textContent=`${a} lines, ${d} chars`,this.statusBarState.lines=a}}},50))},destroyStatusBar(){this.statusBarElement&&this.statusBarElement.parentNode&&(this.statusBarElement.parentNode.removeChild(this.statusBarElement),this.statusBarElement=null)},initAccessibility(){this.editor&&(this.keyboardAccessibility&&this.initKeyboardAccessibility(),this.screenReaderSupport&&this.initScreenReaderSupport(),this.ariaLabels&&Object.keys(this.ariaLabels).length>0&&this.applyAriaLabels())},initKeyboardAccessibility(){let e=this.editor;e.commands.addCommand({name:"gotoLine",bindKey:{win:"Ctrl+G",mac:"Cmd+G"},exec:()=>{this.goToLine()}}),e.commands.addCommand({name:"gotoLineStart",bindKey:{win:"Home",mac:"Home|Ctrl+A"},exec:()=>{let t=e.getCursorPosition();e.moveCursorTo(t.row,0),e.clearSelection()}}),e.commands.addCommand({name:"gotoLineEnd",bindKey:{win:"End",mac:"End|Ctrl+E"},exec:()=>{let t=e.getCursorPosition(),i=e.session.getLine(t.row);e.moveCursorTo(t.row,i.length),e.clearSelection()}}),e.commands.addCommand({name:"selectWord",bindKey:{win:"Ctrl+Shift+Right",mac:"Cmd+Shift+Right"},exec:()=>{e.selection.selectWordRight(),e.renderer.scrollCursorIntoView()}}),e.commands.addCommand({name:"selectWordLeft",bindKey:{win:"Ctrl+Shift+Left",mac:"Cmd+Shift+Left"},exec:()=>{e.selection.selectWordLeft(),e.renderer.scrollCursorIntoView()}}),e.on("focus",()=>{this.announceToScreenReader("Editor focused")}),e.on("blur",()=>{this.announceToScreenReader("Editor unfocused")})},initScreenReaderSupport(){let e=this.editor;e.selection.on("changeCursor",()=>{let t=e.getCursorPosition();this.announceToScreenReader(`Line ${t.row+1}, Column ${t.column+1}`)}),e.selection.on("changeSelection",()=>{let t=e.getSelection();if(t.isEmpty())this.announceToScreenReader("Selection cleared");else{let i=e.session.getTextRange(t.getRange());this.announceToScreenReader(`Selected: ${i.length} characters`)}}),e.session.on("changeMode",()=>{let t=e.session.getMode().$id||"text";this.announceToScreenReader(`Mode changed to: ${t.replace("ace/mode/","").toUpperCase()}`)}),e.on("changeTheme",()=>{let t=e.getTheme()||"textmate";this.announceToScreenReader(`Theme changed to: ${t.replace("ace/theme/","").replace(/_/g," ")}`)})},applyAriaLabels(){let e=this.$el.querySelector(".ace_editor");if(!e)return;Object.entries(this.ariaLabels).forEach(([i,s])=>{let r=this.$el.querySelector(i)||e;r&&(r.setAttribute("aria-label",s),r.setAttribute("role",r.getAttribute("role")||"region"))}),e.setAttribute("role","application"),e.setAttribute("aria-label",this.ariaLabels.editor||"Code editor"),e.setAttribute("aria-multiline","true");let t=this.$el.querySelector(".ace_text-input");t&&(t.setAttribute("aria-label",this.ariaLabels.textarea||"Code input area"),t.setAttribute("aria-describedby","ace-editor-status"))},announceToScreenReader(e){if(!this.screenReaderSupport)return;let t=document.getElementById("ace-screen-reader-announcer");t||(t=document.createElement("div"),t.id="ace-screen-reader-announcer",t.setAttribute("aria-live","polite"),t.setAttribute("aria-atomic","true"),t.style.position="absolute",t.style.left="-10000px",t.style.width="1px",t.style.height="1px",t.style.overflow="hidden",document.body.appendChild(t)),t.textContent=e,setTimeout(()=>{t.textContent=""},100)},changeFontSize(e){!this.editor||!e||(this.currentFontSize=e,this.editor.setOptions({fontSize:e}),this.editor.resize())},changeWordWrap(e){if(!this.editor||!e)return;this.currentWordWrap=e;let t=this.editor.getSession();switch(e){case"off":t.setUseWrapMode(!1);break;case"soft":t.setUseWrapMode(!0),t.setWrapLimitRange(null,null);break;case"hard":t.setUseWrapMode(!0),t.setWrapLimitRange(80,80);break;default:t.setUseWrapMode(!1);break}this.editor.resize()},applyOverscrollSettings(){if(!this.editor||!this.overscrollOptions)return;let t={...{enabled:!0,size:50,behavior:"auto",horizontal:!0,vertical:!0},...this.overscrollOptions};if(!t.enabled){this.editor.renderer.setScrollMargin(0,0,0,0);return}let i=t.vertical?t.size:0,s=t.horizontal?t.size:0,r=t.vertical?t.size:0,o=t.horizontal?t.size:0;if(this.editor.renderer.setScrollMargin(i,s,r,o),t.behavior==="manual"){let l=()=>{};this.editor.renderer.scrollBarV.addEventListener("scroll",l,{passive:!0}),this.editor.renderer.scrollBarH.addEventListener("scroll",l,{passive:!0}),this.eventListeners.push({element:this.editor.renderer.scrollBarV,type:"scroll",handler:l,options:{passive:!0}},{element:this.editor.renderer.scrollBarH,type:"scroll",handler:l,options:{passive:!0}})}let n={};t.behavior!=="none"&&(n.autoScrollEditorIntoView=!0),this.editor.setOptions(n)}}}export{G as default};
